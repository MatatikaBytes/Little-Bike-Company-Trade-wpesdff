version: pipelines/v0.1
name: Send trade stock email
schedule: 0 0 9 * * MON
timeout: 60
max_retries: 0
script: |-
  csv=trade-stock.csv

  curl -f $ENDPOINT_URL/workspaces/$WORKSPACE_ID/resources/$csv \
    -H "Authorization: Bearer $AUTH_TOKEN" \
    > $csv

  export SENDGRID_ATTACHMENTS=$csv

  export SENDGRID_TO_ADDRESSES=$( \
    curl -f $ENDPOINT_URL/workspaces/$WORKSPACE_ID/invitations \
      -H "Authorization: Bearer $AUTH_TOKEN" \
      | jq -r '[._embedded.invitations[] | select(.status == "ACCEPTED") | .email, "'"$SENDGRID_TO_ADDRESSES"'"] | join(",")'
  )

  meltano invoke sendgrid
data_components:
- sendgrid
